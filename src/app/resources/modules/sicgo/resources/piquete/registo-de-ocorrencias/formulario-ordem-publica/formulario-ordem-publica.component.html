<div class="page__content">
    <div class="page__frame">
        <div class="page-tab-header">
            <p class="ml-0 pl-3">
                <i class="bi bi-exclamation-triangle-fill text-warning"></i>
                Os campos marcados com (
                <strong class="asterisco">*</strong>
                ) são de carácter
                <strong>obrigatório</strong>
                .
            </p>


            <nav
                class="navigation"
                id="js--navid"
            >
                <ul class="navigation-menu">
                    <li
                        *ngFor="let option of menuOptions"
                        class="nav-item"
                        [class.active]="currentStep === option.step"
                        [class.disabled]="!isStepAccessible(option.step) && !buscarId()"
                    >
                        <a
                            class="nav-tab t--tab"
                            (click)="isStepAccessible(option.step) || buscarId() ? handleNavigation(option) : null"
                        >
                            <i [class]="option.icon"></i>
                            {{ option.label }}
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>



    <div class="tab__content">
        <!-- Adicione antes do fechamento do form -->


        <form
            [formGroup]="ocorrenciaForm"
            (ngSubmit)="onSubmit()"
        >
            <!-- Passo 1: Dados Primários -->
            <div
                *ngIf="currentStep === 1"
                class="row"
            >
                <!-- Família de crime -->
                <div class="form-group col-md-4 col-sm-6 col-12">
                    <label>
                        <b>Família de crime</b>
                        <span class="asterisco">*</span>
                    </label>
                    <ng-select2
                        class="custom-border ng-select-container"
                        [options]="options"
                        [data]="familiaCrimes"
                        formControlName="sicgo_familia_crime_id"
                        (valueChanged)="handlerTipocrime($event)"
                        [class.is-invalid]="isInvalid('sicgo_familia_crime_id')"
                    >
                    </ng-select2>
                    <div
                        class="error1 mt-2"
                        *ngIf="isInvalid('sicgo_familia_crime_id')"
                    >
                        <small>Família de crime é obrigatório</small>
                    </div>
                </div>


                <!-- Tipo de Crime -->
                <div class="form-group col-md-4 col-sm-6 col-12">
                    <label>
                        <b>Tipo de Crime</b>
                        <span class="asterisco">*</span>
                    </label>
                    <ng-select2
                        class="custom-border ng-select-container"
                        [options]="options"
                        [data]="tipoOcorrencias"
                        formControlName="sicgo_tipo_crime_id"
                        (valueChanged)="selecionarCategoriaCrime($event)"
                        [class.is-invalid]="isInvalid('sicgo_tipo_crime_id')"
                    >
                    </ng-select2>
                    <div
                        class="error1 mt-2"
                        *ngIf="isInvalid('sicgo_tipo_crime_id')"
                    >
                        <small>Tipo de Crime é obrigatório</small>
                    </div>
                </div>


                <!-- Tipicidade -->
                <div class="form-group col-md-4 col-sm-6 col-12">
                    <label>
                        <b>Tipicidade</b>
                        <span class="asterisco">*</span>
                    </label>
                    <ng-select2
                        class="custom-border ng-select-container"
                        [options]="options"
                        [data]="tipoCategorias"
                        formControlName="sicgo_tipicidade_crime_id"
                        [class.is-invalid]="isInvalid('sicgo_tipicidade_crime_id')"
                    >
                    </ng-select2>
                    <div
                        class="error1 mt-2"
                        *ngIf="isInvalid('sicgo_tipicidade_crime_id')"
                    >
                        <small>Tipicidade é obrigatório</small>
                    </div>
                </div>


                <!-- Importância -->
                <div class="form-group col-md-4 col-sm-6 col-12">
                    <label>
                        <b>Importância</b>
                        <span class="asterisco">*</span>
                    </label>
                    <ng-select2
                        class="custom-border ng-select-container"
                        [options]="options"
                        [data]="importancias"
                        formControlName="sicgo_importancia_id"
                        [class.is-invalid]="isInvalid('sicgo_importancia_id')"
                    >
                    </ng-select2>
                    <div
                        class="error1 mt-2"
                        *ngIf="isInvalid('sicgo_importancia_id')"
                    >
                        <small>Importância é obrigatório</small>
                    </div>
                </div>


                <!-- Tipo de Local -->
                <div class="form-group col-md-4 col-sm-6 col-12">
                    <label>
                        <b>Tipo de Local</b>
                        <span class="asterisco">*</span>
                    </label>
                    <ng-select2
                        class="custom-border ng-select-container"
                        [options]="options"
                        [data]="tipolocals"
                        formControlName="sicgo_tipo_local_id"
                        [class.is-invalid]="isInvalid('sicgo_tipo_local_id')"
                    >
                    </ng-select2>
                    <div
                        class="error1 mt-2"
                        *ngIf="isInvalid('sicgo_tipo_local_id')"
                    >
                        <small>Tipo de Local é obrigatório</small>
                    </div>
                </div>


                <!-- Local -->
                <div class="form-group col-md-4 col-sm-6 col-12">
                    <label>
                        <b>Local</b>
                        <span class="asterisco">*</span>
                    </label>
                    <input
                        type="text"
                        class="form-control bt-radius"
                        formControlName="local"
                        [class.is-invalid]="isInvalid('local')"
                    >
                    <div
                        class="error1 mt-2"
                        *ngIf="isInvalid('local')"
                    >
                        <small>Local é obrigatório</small>
                    </div>
                </div>


                <!-- Província -->
                <div class="form-group col-md-4 col-sm-6 col-12">
                    <label>
                        <b>Província</b>
                        <span class="asterisco">*</span>
                    </label>
                    <ng-select2
                        class="custom-border ng-select-container"
                        [options]="options"
                        [data]="provincias"
                        [(ngModel)]="provincia"
                        formControlName="provincia_id"
                        (valueChanged)="handlerProvincias($event)"
                        [class.is-invalid]="isInvalid('provincia_id')"
                    >
                    </ng-select2>
                    <div
                        class="error1 mt-2"
                        *ngIf="isInvalid('provincia_id')"
                    >
                        <small>Província é obrigatório</small>
                    </div>
                </div>


                <!-- Município -->
                <div class="form-group col-md-4 col-sm-6 col-12">
                    <label>
                        <b>Município</b>
                    </label>
                    <ng-select2
                        class="custom-border ng-select-container"
                        [options]="options"
                        [data]="municipios"
                        formControlName="municipio_id"
                        (valueChanged)="selecionarMunicipio($event)"
                    >
                    </ng-select2>
                </div>


                <!-- Distrito -->
                <div class="form-group col-md-4 col-sm-6 col-12">
                    <label>
                        <b>Distrito</b>
                    </label>
                    <ng-select2
                        class="custom-border ng-select-container"
                        [options]="options"
                        [data]="distritos"
                        formControlName="distrito_id"
                    >
                    </ng-select2>
                </div>


                <!-- Data da Ocorrência -->
                <div class="form-group col-md-12 col-sm-12 col-12">
                    <label>
                        <b>Data da ocorrência</b>
                        <span class="asterisco">*</span>
                    </label>
                    <input
                        type="datetime-local"
                        class="form-control bt-radius"
                        formControlName="data_ocorrido"
                        [class.is-invalid]="isInvalid('data_ocorrido')"
                        [max]="validarData"
                    >
                    <div
                        class="error1 mt-2"
                        *ngIf="ocorrenciaForm.controls['data_ocorrido'].errors?.['futureDate']"
                    >
                        A data não pode ser no futuro.
                    </div>
                    <div
                        class="error1 mt-2"
                        *ngIf="isInvalid('data_ocorrido')"
                    >
                        <small>Data ocorrido é obrigatório</small>
                    </div>
                </div>
            </div>


            <!-- Passo 2: Intervenientes -->
            <div
                *ngIf="currentStep === 2"
                class="row"
            >



                <!-- Consulta BI -->
                <div class="col-12">
                    <div class="row justify-content-between">
                        <div class="form-group col-md-6 col-sm-6 col-6">
                            <small>
                                Adicione os Interveniente associados ao envento
                            </small>
                            <input
                                type="text"
                                id="biNumber"
                                class="form-control bt-radius"
                                [(ngModel)]="biNumber"
                                name="biNumber"
                                (input)="onBiInputChange()"
                                placeholder="Consultar Bilhete de Identidade"
                                required
                                minlength="8"
                                maxlength="14"
                                #biInput="ngModel"
                                [class.is-invalid]="biInput.invalid && biInput.touched"
                                [disabled]="isLoading"
                            >
                            <div
                                class="error1 mt-2"
                                *ngIf="biInput.invalid && biInput.touched"
                            >
                                <small>O BI deve ter entre 8 e 14 caracteres</small>
                            </div>
                        </div>
                        <div class="d-flex col-md-5 col-sm-3 col-5">
                          <div class="btn-group" role="group" aria-label="Basic example">
                            <button type="button" class="btn btn-primary" (click)="addParticipante()">
                            <i class="bi bi-person-fill-add"></i> Adicionar</button>
                            <button type="button" class="btn btn-primary" *ngIf="shouldShowAddVehicleButton()"  (click)="addVeiculo()">
                              <i class="bi bi-car-front-fill"></i>
                                        Adicionar</button>
                          </div>
                             
                        </div>
                    </div>



                </div>
                <div
                    formArrayName="veiculos"
                    class="col-xl-12 col-lg-12 col-md-12 col-sm-12"
                >
                    <div
                        *ngFor="let veiculo of veiculos; let i = index"
                        [formGroupName]="i"
                    >
                        <div class="row">
                            <div class="col-xl-7 col-lg-7 col-md-7 col-sm-7 mt-4">
                                <label for="matricula">
                                    <b>Matrícula</b>
                                    <span class="text-red">*</span>
                                </label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="matricula"
                                    formControlName="matricula"
                                    placeholder="Ex: ABCD 12 AB"
                                >
                                <span
                                    *ngIf="veiculo.get('matricula')?.valid && veiculo.get('matricula')?.touched"
                                    class="icon icon-valid"
                                >
                                    ✔️
                                </span>
                                <span
                                    *ngIf="veiculo.get('matricula')?.invalid && veiculo.get('matricula')?.touched"
                                    class="icon icon-invalid"
                                >
                                    ❌
                                </span>
                                <div
                                    *ngIf="veiculo.get('matricula')?.invalid && veiculo.get('matricula')?.touched"
                                    class="error"
                                >
                                    Matrícula inválida! O formato correto é: ABCD 12 AB.
                                </div>
                            </div>
                            <div class="col-xl-5 col-lg-5 col-md-5 col-sm-12 mt-4">
                                <label>
                                    <b>DANOS-AVALIADOS</b>
                                    <span class="text-red">*</span>
                                </label>
                                <input
                                    type="text"
                                    formControlName="danos"
                                    class="form-control"
                                    placeholder="500.000kz"
                                >
                            </div>
                        </div>
                        <div class="row">
                            <div class="form-group col-4 mt-2">
                                <label>
                                    <b>Marca</b>
                                    <span class="text-red">*</span>
                                </label>
                                <br>
                                <ng-select2
                                    formControlName="marca"
                                    [options]="options"
                                    [(ngModel)]="selectedMarca"
                                    [data]="marcas"
                                    [valueField]="'id'"
                                    [labelField]="'text'"
                                    (ngModelChange)="onMarcaChange()"
                                ></ng-select2>
                            </div>
                            <div class="form-group col-xl-4 col-lg-4 col-md-4 col-sm-4 mt-2">
                                <label>
                                    <b>Modelo</b>
                                    <span class="text-red">*</span>
                                </label>
                                <br>
                                <ng-select2
                                    formControlName="modelo"
                                    [options]="options"
                                    [(ngModel)]="selectedModelo"
                                    [data]="modelosDisponiveis"
                                    [valueField]="'id'"
                                    [labelField]="'text'"
                                ></ng-select2>
                            </div>
                            <div class="col-xl-4 col-lg-4 col-md-4 col-sm-4 mt-2">
                                <label>
                                    <b>COR</b>
                                    <span class="text-red">*</span>
                                </label>
                                <select
                                    formControlName="cor"
                                    class="form-control"
                                >
                                    <option value="Vermelha">Vermelha</option>
                                    <option value="Azul">Azul</option>
                                    <option value="Castanha">Castanha</option>
                                    <option value="Verde">Verde</option>
                                    <option value="Preta">Preta</option>
                                    <option value="Sizenta">Sizenta</option>
                                    <option value="Amarela">Amarela</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="btn-group d-grid gap-2 mx-auto p-2 col-xl-12 col-lg-12 col-md-12 col-sm-12 mt-4">
                                <button
                                    type="button"
                                    class="btn btn-danger"
                                    (click)="removeVeiculo(i)"
                                >
                                    <i class="bi bi-trash3-fill"></i>
                                    Remover o veículo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Lista de Participantes -->
                <div
                    formArrayName="participantes"
                    class="col-12"
                >
                    <div
                        *ngFor="let item of participantes; let i = index"
                        [formGroup]="item"
                        class=" p-3 mb-3"
                    >
                        <div class="row">


                            <div class="col-md-7 col-sm-4 col-12">
                                <label>
                                    <b>Nome</b>
                                    <span class="asterisco">*</span>
                                </label>
                                <input
                                    type="text"
                                    class="form-control bt-radius"
                                    [value]="this.pesquisarDadosPessoaisForm.value.name"
                                    formControlName="nome"
                                    [class.is-invalid]="isInvalid('nome')"
                                >
                                <div
                                    class="error1 mt-2"
                                    *ngIf="isInvalid('nome')"
                                >
                                    <small>Nome é obrigatório</small>
                                </div>
                            </div>


                            <div class="col-md-4 col-sm-4 col-12">
                                <label>
                                    <b>Gênero</b>
                                    <span class="asterisco">*</span>
                                </label>
                                <select
                                    formControlName="genero"
                                    class="form-control bt-radius"
                                    [class.is-invalid]="isInvalid('genero')"
                                >
                                    <option value="Masculino">Masculino</option>
                                    <option value="Femenino">Femenino</option>
                                </select>
                                <div
                                    class="error1 mt-2"
                                    *ngIf="isInvalid('genero')"
                                >
                                    <small>Gênero é obrigatório</small>
                                </div>
                            </div>


                            <div class="col-md-4 col-sm-4 col-12">
                                <label>
                                    <b>Tipo de Interveniente</b>
                                    <span class="asterisco">*</span>
                                </label>
                                <select
                                    formControlName="sicgo_denucia"
                                    class="form-control bt-radius"
                                    [class.is-invalid]="isInvalid('sicgo_denucia')"
                                >
                                    <option
                                        *ngFor="let tipo of tiposInterveniente"
                                        [value]="tipo.value"
                                    >
                                        {{ tipo.label }}
                                    </option>
                                </select>
                                <div
                                    class="error1 mt-2"
                                    *ngIf="isInvalid('sicgo_denucia')"
                                >
                                    <small>Tipo de interveniente é obrigatório</small>
                                </div>
                            </div>


                            <div class="col-md-6 col-sm-4 col-12">
                                <label>
                                    <b>Telefone</b>
                                </label>
                                <input
                                    type="text"
                                    class="form-control bt-radius"
                                    telefonekvMask
                                    formControlName="tel"
                                    placeholder="Telefone {{ i + 1 }}"
                                >
                                <div
                                    *ngIf="isInvalid('tel')"
                                    class="text-danger"
                                >
                                    Número de telefone inválido. Use um formato angolano válido (9XX XXX XXX ou 2XX XXX XXX).
                                </div>
                                <div
                                    *ngIf="isInvalid('tel')"
                                    class="text-danger"
                                >
                                    Telefone é obrigatório.
                                </div>
                            </div>


                            <div class="col-md-5 col-sm-5 col-12">
                                <label>
                                    <b>Remover</b>
                                </label>
                                <button
                                    type="button"
                                    class="btn btn-danger w-100"
                                    (click)="removeParticipante(i)"
                                >
                                    <i class="bi bi-trash3-fill"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Passo 3: Descrição do Evento -->
            <div
                *ngIf="currentStep === 3"
                class="row"
            >
                <div class="col-12">
                    <div class="form-group">
                        <label>
                            <b>Descrição do Evento</b>
                            <span class="asterisco">*</span>
                        </label>
                        <editor
                            [disabled]="false"
                            formControlName="descricao"
                            [class.is-invalid]="isInvalid('descricao')"
                            placeholder="Descrição detalhada do evento"
                        ></editor>
                        <div
                            class="error1 mt-2"
                            *ngIf="isInvalid('descricao')"
                        >
                            <small>Descrição é obrigatória</small>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Passo 4: Meios -->
            <div
                *ngIf="currentStep === 4"
                class="row"
            >
                <div class="col-12">
                    <div [class.hidden]="isSelectHidden">
                        <div *ngIf="objectoCrimes.length === 0">
                            <p>Nenhum objeto de crime disponível</p>
                        </div>
                        <div
                            *ngIf="objectoCrimes.length > 0"
                            class="form-group"
                        >
                            <label>
                                <b>Armas selecionadas</b>
                            </label>
                            <ng-select2
                                class="form-control"
                                [options]="options"
                                [data]="objectoCrimes"
                                [(ngModel)]="Crimesobjecto"
                                formControlName="sicgo_objecto_crimes_id"
                                [class.is-invalid]="isInvalid('sicgo_objecto_crimes_id')"
                            >
                            </ng-select2>
                            <div
                                class="error1 mt-2"
                                *ngIf="isInvalid('sicgo_objecto_crimes_id')"
                            >
                                <small>Objeto crimes é obrigatório</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Rodapé do Formulário -->
            <div class="modal-footer">
                <div
                    class="btn-group"
                    role="group"
                >
                    <button
                        type="button"
                        class="btn btn-primary"
                        (click)="prevStep()"
                        [disabled]="currentStep === 1"
                    >
                        Anterior
                    </button>
                    <button
                        type="button"
                        class="btn btn-primary"
                        (click)="nextStep()"
                        [disabled]="!canSubmit()"
                    >
                        Próximo
                    </button>
                </div>


                <div
                    class="btn-group w-100 mt-2"
                    role="group"
                >
                    <button
                        type="reset"
                        class="btn btn-danger"
                        (click)="reiniciarFormulario()"
                    >
                        Limpar
                    </button>
                    <button
                        *ngIf="currentStep === 4 && canSubmit()"
                        type="submit"
                        class="btn btn-primary w-100"
                        [disabled]="isLoading || submitted"
                    >
                        <span
                            *ngIf="isLoading; else regista"
                            class="loading-text"
                        >
                            <i class="spinner-border spinner-border-sm"></i>
                            A processar...
                        </span>
                        <ng-template #regista>
                            <i class="bi bi-floppy2"></i>
                            {{ ocorrenciaId ? "Actualizar" : "Registar" }}
                        </ng-template>
                    </button>
                </div>
            </div>
        </form>
    </div>


</div>
